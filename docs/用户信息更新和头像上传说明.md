# 用户信息更新和头像上传功能说明

## 功能概述

实现了用户信息更新和头像上传功能，头像文件会上传到MinIO对象存储服务。

## 功能列表

### 1. 更新用户信息
**接口**: `PUT /user/update`

**功能**: 更新当前登录用户的个人信息

**请求头**:
```
Authorization: {sa-token}
```

**请求体** (`UpdateUserDTO`):
```json
{
  "nickname": "新昵称",
  "email": "newemail@example.com",
  "phone": "13900139000",
  "avatarUrl": "http://localhost:9000/content-hub/avatars/2024-01-01/xxx.jpg",
  "bio": "这是我的新简介",
  "gender": 1,
  "birthday": "1990-01-01",
  "location": "上海市"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null,
  "timestamp": 1730000000000
}
```

**注意事项**:
- 所有字段都是可选的，只更新提供的字段
- 邮箱和手机号会检查是否被其他用户使用
- 需要Sa-Token认证

### 2. 上传头像
**接口**: `POST /user/avatar/upload`

**功能**: 上传并更新当前用户的头像

**请求头**:
```
Authorization: {sa-token}
Content-Type: multipart/form-data
```

**请求参数**:
- `file`: 头像文件（MultipartFile）

**响应**:
```json
{
  "code": 200,
  "message": "头像上传成功",
  "data": "http://localhost:9000/content-hub/avatars/2024-10-30/abc123.jpg",
  "timestamp": 1730000000000
}
```

**限制**:
- 文件大小：最大2MB
- 文件类型：必须是图片格式（image/*）
- 需要Sa-Token认证

### 3. 文件服务接口

#### 3.1 上传头像（文件服务）
**接口**: `POST /file/avatar/upload`

**功能**: 直接上传头像到MinIO

**请求体**:
```
multipart/form-data
file: 头像文件
```

**响应**:
```json
{
  "code": 200,
  "message": "头像上传成功",
  "data": "http://localhost:9000/content-hub/avatars/2024-10-30/abc123.jpg",
  "timestamp": 1730000000000
}
```

#### 3.2 上传文件
**接口**: `POST /file/upload`

**功能**: 上传文件到指定目录

**请求参数**:
- `file`: 文件
- `directory`: 目录名称（可选，默认为"files"）

#### 3.3 删除文件
**接口**: `DELETE /file/delete`

**功能**: 从MinIO删除文件

**请求参数**:
- `fileName`: 文件名（例如：avatars/2024-01-01/xxx.jpg）

## 技术实现

### 1. 服务架构
```
用户服务 (8001)
    ├── UserController: 提供更新用户信息和上传头像接口
    ├── UserService: 业务逻辑实现
    └── FileServiceClient (Feign): 调用文件服务

文件服务 (8006)
    ├── FileController: 提供文件上传下载接口
    ├── FileService: 文件处理逻辑
    ├── MinioConfig: MinIO客户端配置
    └── MinioInitializer: 自动创建Bucket
```

### 2. MinIO配置
**配置文件** (`contenthub-file-service/application.yml`):
```yaml
minio:
  endpoint: http://192.168.200.130:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket-name: content-hub
```

**Bucket初始化**:
- 启动时自动创建`content-hub` bucket
- 设置为公开读取权限
- 所有上传的文件可直接通过URL访问

### 3. 文件存储规则
**头像文件路径格式**:
```
avatars/{日期}/{UUID}.{扩展名}
例如: avatars/2024-10-30/a1b2c3d4e5f6.jpg
```

**访问URL格式**:
```
http://{minio-endpoint}/{bucket-name}/{文件路径}
例如: http://localhost:9000/content-hub/avatars/2024-10-30/a1b2c3d4e5f6.jpg
```

## 使用流程

### 前端上传头像流程

```javascript
// 1. 选择文件
const file = event.target.files[0];

// 2. 创建FormData
const formData = new FormData();
formData.append('file', file);

// 3. 上传头像（方式一：直接调用用户服务）
const response = await fetch('http://localhost:8001/user/avatar/upload', {
  method: 'POST',
  headers: {
    'Authorization': saToken // Sa-Token
  },
  body: formData
});

const result = await response.json();
console.log('头像URL:', result.data);

// 4. 头像会自动更新到用户信息中
```

**或者分两步上传（方式二）**:

```javascript
// 步骤1: 先上传到文件服务
const uploadResponse = await fetch('http://localhost:8006/file/avatar/upload', {
  method: 'POST',
  body: formData
});
const uploadResult = await uploadResponse.json();
const avatarUrl = uploadResult.data;

// 步骤2: 更新用户信息
const updateResponse = await fetch('http://localhost:8001/user/update', {
  method: 'PUT',
  headers: {
    'Authorization': saToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    avatarUrl: avatarUrl
  })
});
```

## 测试步骤

### 1. 启动服务
```bash
# 启动Nacos
# 启动MinIO
# 启动用户服务
cd contenthub-user-service
mvn spring-boot:run

# 启动文件服务
cd contenthub-file-service
mvn spring-boot:run
```

### 2. 使用Swagger测试

**用户服务Swagger**: http://localhost:8001/swagger-ui.html

**文件服务Swagger**: http://localhost:8006/swagger-ui.html

### 3. 使用curl测试

**上传头像**:
```bash
curl -X 'POST' \
  'http://localhost:8001/user/avatar/upload' \
  -H 'Authorization: {你的sa-token}' \
  -F 'file=@avatar.jpg'
```

**更新用户信息**:
```bash
curl -X 'PUT' \
  'http://localhost:8001/user/update' \
  -H 'Authorization: {你的sa-token}' \
  -H 'Content-Type: application/json' \
  -d '{
    "nickname": "新昵称",
    "bio": "这是我的简介"
  }'
```

## 注意事项

1. **MinIO配置**
   - 确保MinIO服务已启动并可访问
   - 默认账号密码: minioadmin/minioadmin
   - 端口: 9000 (API), 9001 (Console)

2. **认证要求**
   - 所有接口都需要Sa-Token认证
   - 先调用登录接口获取Token
   - 在Swagger中点击🔓按钮添加Token

3. **文件限制**
   - 头像最大2MB
   - 必须是图片格式
   - 支持jpg、png、gif等常见格式

4. **Feign调用**
   - 用户服务通过Feign调用文件服务
   - 需要确保文件服务已注册到Nacos
   - 服务名称: `contenthub-file-service`

5. **错误处理**
   - 文件上传失败会抛出BusinessException
   - 邮箱/手机号冲突会返回错误提示
   - MinIO连接失败会记录详细日志

## 后续优化建议

1. **图片处理**
   - 添加图片压缩功能
   - 生成缩略图
   - 支持图片裁剪

2. **安全性**
   - 添加图片内容检测（违规图片过滤）
   - 限制上传频率
   - 添加水印

3. **性能优化**
   - 使用CDN加速图片访问
   - 实现图片懒加载
   - 缓存用户头像URL

4. **功能扩展**
   - 支持多文件上传
   - 添加文件管理界面
   - 实现文件版本控制

