# ç”¨æˆ·ä¿¡æ¯æ›´æ–°å’Œå¤´åƒä¸Šä¼ åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ç”¨æˆ·ä¿¡æ¯æ›´æ–°å’Œå¤´åƒä¸Šä¼ åŠŸèƒ½ï¼Œå¤´åƒæ–‡ä»¶ä¼šä¸Šä¼ åˆ°MinIOå¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚

## åŠŸèƒ½åˆ—è¡¨

### 1. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
**æ¥å£**: `PUT /user/update`

**åŠŸèƒ½**: æ›´æ–°å½“å‰ç™»å½•ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯

**è¯·æ±‚å¤´**:
```
Authorization: {sa-token}
```

**è¯·æ±‚ä½“** (`UpdateUserDTO`):
```json
{
  "nickname": "æ–°æ˜µç§°",
  "email": "newemail@example.com",
  "phone": "13900139000",
  "avatarUrl": "http://localhost:9000/content-hub/avatars/2024-01-01/xxx.jpg",
  "bio": "è¿™æ˜¯æˆ‘çš„æ–°ç®€ä»‹",
  "gender": 1,
  "birthday": "1990-01-01",
  "location": "ä¸Šæµ·å¸‚"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ›´æ–°æˆåŠŸ",
  "data": null,
  "timestamp": 1730000000000
}
```

**æ³¨æ„äº‹é¡¹**:
- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œåªæ›´æ–°æä¾›çš„å­—æ®µ
- é‚®ç®±å’Œæ‰‹æœºå·ä¼šæ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
- éœ€è¦Sa-Tokenè®¤è¯

### 2. ä¸Šä¼ å¤´åƒ
**æ¥å£**: `POST /user/avatar/upload`

**åŠŸèƒ½**: ä¸Šä¼ å¹¶æ›´æ–°å½“å‰ç”¨æˆ·çš„å¤´åƒ

**è¯·æ±‚å¤´**:
```
Authorization: {sa-token}
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**:
- `file`: å¤´åƒæ–‡ä»¶ï¼ˆMultipartFileï¼‰

**å“åº”**:
```json
{
  "code": 200,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": "http://localhost:9000/content-hub/avatars/2024-10-30/abc123.jpg",
  "timestamp": 1730000000000
}
```

**é™åˆ¶**:
- æ–‡ä»¶å¤§å°ï¼šæœ€å¤§2MB
- æ–‡ä»¶ç±»å‹ï¼šå¿…é¡»æ˜¯å›¾ç‰‡æ ¼å¼ï¼ˆimage/*ï¼‰
- éœ€è¦Sa-Tokenè®¤è¯

### 3. æ–‡ä»¶æœåŠ¡æ¥å£

#### 3.1 ä¸Šä¼ å¤´åƒï¼ˆæ–‡ä»¶æœåŠ¡ï¼‰
**æ¥å£**: `POST /file/avatar/upload`

**åŠŸèƒ½**: ç›´æ¥ä¸Šä¼ å¤´åƒåˆ°MinIO

**è¯·æ±‚ä½“**:
```
multipart/form-data
file: å¤´åƒæ–‡ä»¶
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": "http://localhost:9000/content-hub/avatars/2024-10-30/abc123.jpg",
  "timestamp": 1730000000000
}
```

#### 3.2 ä¸Šä¼ æ–‡ä»¶
**æ¥å£**: `POST /file/upload`

**åŠŸèƒ½**: ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•

**è¯·æ±‚å‚æ•°**:
- `file`: æ–‡ä»¶
- `directory`: ç›®å½•åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º"files"ï¼‰

#### 3.3 åˆ é™¤æ–‡ä»¶
**æ¥å£**: `DELETE /file/delete`

**åŠŸèƒ½**: ä»MinIOåˆ é™¤æ–‡ä»¶

**è¯·æ±‚å‚æ•°**:
- `fileName`: æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šavatars/2024-01-01/xxx.jpgï¼‰

## æŠ€æœ¯å®ç°

### 1. æœåŠ¡æ¶æ„
```
ç”¨æˆ·æœåŠ¡ (8001)
    â”œâ”€â”€ UserController: æä¾›æ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œä¸Šä¼ å¤´åƒæ¥å£
    â”œâ”€â”€ UserService: ä¸šåŠ¡é€»è¾‘å®ç°
    â””â”€â”€ FileServiceClient (Feign): è°ƒç”¨æ–‡ä»¶æœåŠ¡

æ–‡ä»¶æœåŠ¡ (8006)
    â”œâ”€â”€ FileController: æä¾›æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¥å£
    â”œâ”€â”€ FileService: æ–‡ä»¶å¤„ç†é€»è¾‘
    â”œâ”€â”€ MinioConfig: MinIOå®¢æˆ·ç«¯é…ç½®
    â””â”€â”€ MinioInitializer: è‡ªåŠ¨åˆ›å»ºBucket
```

### 2. MinIOé…ç½®
**é…ç½®æ–‡ä»¶** (`contenthub-file-service/application.yml`):
```yaml
minio:
  endpoint: http://192.168.200.130:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket-name: content-hub
```

**Bucketåˆå§‹åŒ–**:
- å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º`content-hub` bucket
- è®¾ç½®ä¸ºå…¬å¼€è¯»å–æƒé™
- æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶å¯ç›´æ¥é€šè¿‡URLè®¿é—®

### 3. æ–‡ä»¶å­˜å‚¨è§„åˆ™
**å¤´åƒæ–‡ä»¶è·¯å¾„æ ¼å¼**:
```
avatars/{æ—¥æœŸ}/{UUID}.{æ‰©å±•å}
ä¾‹å¦‚: avatars/2024-10-30/a1b2c3d4e5f6.jpg
```

**è®¿é—®URLæ ¼å¼**:
```
http://{minio-endpoint}/{bucket-name}/{æ–‡ä»¶è·¯å¾„}
ä¾‹å¦‚: http://localhost:9000/content-hub/avatars/2024-10-30/a1b2c3d4e5f6.jpg
```

## ä½¿ç”¨æµç¨‹

### å‰ç«¯ä¸Šä¼ å¤´åƒæµç¨‹

```javascript
// 1. é€‰æ‹©æ–‡ä»¶
const file = event.target.files[0];

// 2. åˆ›å»ºFormData
const formData = new FormData();
formData.append('file', file);

// 3. ä¸Šä¼ å¤´åƒï¼ˆæ–¹å¼ä¸€ï¼šç›´æ¥è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼‰
const response = await fetch('http://localhost:8001/user/avatar/upload', {
  method: 'POST',
  headers: {
    'Authorization': saToken // Sa-Token
  },
  body: formData
});

const result = await response.json();
console.log('å¤´åƒURL:', result.data);

// 4. å¤´åƒä¼šè‡ªåŠ¨æ›´æ–°åˆ°ç”¨æˆ·ä¿¡æ¯ä¸­
```

**æˆ–è€…åˆ†ä¸¤æ­¥ä¸Šä¼ ï¼ˆæ–¹å¼äºŒï¼‰**:

```javascript
// æ­¥éª¤1: å…ˆä¸Šä¼ åˆ°æ–‡ä»¶æœåŠ¡
const uploadResponse = await fetch('http://localhost:8006/file/avatar/upload', {
  method: 'POST',
  body: formData
});
const uploadResult = await uploadResponse.json();
const avatarUrl = uploadResult.data;

// æ­¥éª¤2: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
const updateResponse = await fetch('http://localhost:8001/user/update', {
  method: 'PUT',
  headers: {
    'Authorization': saToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    avatarUrl: avatarUrl
  })
});
```

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨Nacos
# å¯åŠ¨MinIO
# å¯åŠ¨ç”¨æˆ·æœåŠ¡
cd contenthub-user-service
mvn spring-boot:run

# å¯åŠ¨æ–‡ä»¶æœåŠ¡
cd contenthub-file-service
mvn spring-boot:run
```

### 2. ä½¿ç”¨Swaggeræµ‹è¯•

**ç”¨æˆ·æœåŠ¡Swagger**: http://localhost:8001/swagger-ui.html

**æ–‡ä»¶æœåŠ¡Swagger**: http://localhost:8006/swagger-ui.html

### 3. ä½¿ç”¨curlæµ‹è¯•

**ä¸Šä¼ å¤´åƒ**:
```bash
curl -X 'POST' \
  'http://localhost:8001/user/avatar/upload' \
  -H 'Authorization: {ä½ çš„sa-token}' \
  -F 'file=@avatar.jpg'
```

**æ›´æ–°ç”¨æˆ·ä¿¡æ¯**:
```bash
curl -X 'PUT' \
  'http://localhost:8001/user/update' \
  -H 'Authorization: {ä½ çš„sa-token}' \
  -H 'Content-Type: application/json' \
  -d '{
    "nickname": "æ–°æ˜µç§°",
    "bio": "è¿™æ˜¯æˆ‘çš„ç®€ä»‹"
  }'
```

## æ³¨æ„äº‹é¡¹

1. **MinIOé…ç½®**
   - ç¡®ä¿MinIOæœåŠ¡å·²å¯åŠ¨å¹¶å¯è®¿é—®
   - é»˜è®¤è´¦å·å¯†ç : minioadmin/minioadmin
   - ç«¯å£: 9000 (API), 9001 (Console)

2. **è®¤è¯è¦æ±‚**
   - æ‰€æœ‰æ¥å£éƒ½éœ€è¦Sa-Tokenè®¤è¯
   - å…ˆè°ƒç”¨ç™»å½•æ¥å£è·å–Token
   - åœ¨Swaggerä¸­ç‚¹å‡»ğŸ”“æŒ‰é’®æ·»åŠ Token

3. **æ–‡ä»¶é™åˆ¶**
   - å¤´åƒæœ€å¤§2MB
   - å¿…é¡»æ˜¯å›¾ç‰‡æ ¼å¼
   - æ”¯æŒjpgã€pngã€gifç­‰å¸¸è§æ ¼å¼

4. **Feignè°ƒç”¨**
   - ç”¨æˆ·æœåŠ¡é€šè¿‡Feignè°ƒç”¨æ–‡ä»¶æœåŠ¡
   - éœ€è¦ç¡®ä¿æ–‡ä»¶æœåŠ¡å·²æ³¨å†Œåˆ°Nacos
   - æœåŠ¡åç§°: `contenthub-file-service`

5. **é”™è¯¯å¤„ç†**
   - æ–‡ä»¶ä¸Šä¼ å¤±è´¥ä¼šæŠ›å‡ºBusinessException
   - é‚®ç®±/æ‰‹æœºå·å†²çªä¼šè¿”å›é”™è¯¯æç¤º
   - MinIOè¿æ¥å¤±è´¥ä¼šè®°å½•è¯¦ç»†æ—¥å¿—

## åç»­ä¼˜åŒ–å»ºè®®

1. **å›¾ç‰‡å¤„ç†**
   - æ·»åŠ å›¾ç‰‡å‹ç¼©åŠŸèƒ½
   - ç”Ÿæˆç¼©ç•¥å›¾
   - æ”¯æŒå›¾ç‰‡è£å‰ª

2. **å®‰å…¨æ€§**
   - æ·»åŠ å›¾ç‰‡å†…å®¹æ£€æµ‹ï¼ˆè¿è§„å›¾ç‰‡è¿‡æ»¤ï¼‰
   - é™åˆ¶ä¸Šä¼ é¢‘ç‡
   - æ·»åŠ æ°´å°

3. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡è®¿é—®
   - å®ç°å›¾ç‰‡æ‡’åŠ è½½
   - ç¼“å­˜ç”¨æˆ·å¤´åƒURL

4. **åŠŸèƒ½æ‰©å±•**
   - æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 
   - æ·»åŠ æ–‡ä»¶ç®¡ç†ç•Œé¢
   - å®ç°æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶

