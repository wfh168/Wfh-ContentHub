# 内容社区平台 - 项目架构设计

## 一、系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   用户前端    │  │   管理后台    │  │  移动端H5     │      │
│  │  (Vue 3)     │  │  (Vue 3)     │  │  (Vue 3)     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ HTTP/HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        API网关层                              │
│              Spring Cloud Gateway                            │
│  - 路由转发  - 统一鉴权  - 限流熔断  - 跨域处理              │
└─────────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   用户服务    │  │   内容服务    │  │   评论服务    │
│ User Service │  │Content Service│ │Comment Service│
└──────────────┘  └──────────────┘  └──────────────┘
           │               │               │
           └───────────────┼───────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      基础设施层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  Nacos   │  │  Redis   │  │  MySQL   │  │   ES     │   │
│  │注册/配置 │  │  缓存     │  │  数据库   │  │  搜索    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │RabbitMQ  │  │  MinIO   │  │ Sentinel │                 │
│  │消息队列   │  │对象存储   │  │ 熔断降级 │                 │
│  └──────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

## 二、微服务划分

### 2.1 服务列表

| 服务名称 | 端口 | 职责 | 数据库 |
|---------|------|------|--------|
| gateway-service | 8080 | API网关，统一入口 | - |
| user-service | 8001 | 用户管理、认证授权 | user_db |
| content-service | 8002 | 文章管理、分类标签 | content_db |
| comment-service | 8003 | 评论管理 | comment_db |
| notification-service | 8004 | 消息通知 | notification_db |
| search-service | 8005 | 全文搜索 | - (Elasticsearch) |
| file-service | 8006 | 文件上传管理 | file_db |
| admin-service | 8007 | 管理后台 | admin_db |

### 2.2 服务依赖关系

```
gateway-service
    ├── user-service
    ├── content-service
    ├── comment-service
    ├── notification-service
    ├── search-service
    ├── file-service
    └── admin-service

comment-service
    ├── user-service (获取用户信息)
    └── content-service (验证文章存在)

content-service
    └── user-service (获取用户信息)

notification-service
    ├── user-service (获取用户信息)
    ├── content-service (文章相关通知)
    └── comment-service (评论相关通知)
```

## 三、技术选型详细说明

### 3.1 后端技术栈

#### Spring Cloud Alibaba 组件
- **Spring Cloud Gateway**: 网关服务
- **Nacos**: 服务注册发现 + 配置中心
- **Sentinel**: 流量控制、熔断降级
- **OpenFeign**: 服务间调用
- **Seata** (可选): 分布式事务

#### 数据层
- **MyBatis-Plus**: ORM框架
- **Druid**: 数据库连接池
- **Redisson**: Redis客户端（分布式锁）

#### 工具类
- **Hutool**: Java工具类库
- **Lombok**: 简化代码
- **MapStruct**: 对象映射

### 3.2 前端技术栈

#### 用户前端
- Vue 3 + TypeScript
- Vite
- Element Plus
- Pinia
- Vue Router
- Axios

#### 管理后台
- Vue 3 + TypeScript
- Vite
- Ant Design Vue
- Pinia
- Vue Router
- Axios
- ECharts

## 四、数据库设计原则

### 4.1 数据库拆分策略

**按业务垂直拆分：**
- `user_db`: 用户、认证、关注等
- `content_db`: 文章、分类、标签等
- `comment_db`: 评论相关
- `notification_db`: 通知相关
- `file_db`: 文件相关
- `admin_db`: 系统配置、日志等

### 4.2 读写分离（可选）

主库负责写操作，从库负责读操作，通过中间件实现自动路由。

## 五、缓存策略

### 5.1 多级缓存

1. **本地缓存**: Caffeine（热点数据）
2. **分布式缓存**: Redis（共享数据）
3. **CDN缓存**: 静态资源（图片、CSS、JS）

### 5.2 缓存更新策略

- **Cache Aside**: 查询时先查缓存，缓存未命中查数据库并写入缓存
- **Write Through**: 写数据时同时更新缓存和数据库
- **失效策略**: 设置合理的过期时间

## 六、消息队列使用场景

### 6.1 异步处理

- 文章发布后：异步更新搜索索引
- 评论发布后：异步发送通知
- 用户操作：异步更新统计数据

### 6.2 解耦

- 通知服务通过MQ接收通知事件，避免直接调用
- 搜索服务通过MQ同步文章数据

## 七、安全设计

### 7.1 认证授权

- **JWT Token**: 无状态认证
- **Refresh Token**: 刷新机制
- **RBAC**: 基于角色的权限控制

### 7.2 接口安全

- **接口签名**: 防重放攻击
- **限流**: 防止恶意请求
- **参数校验**: 防止SQL注入、XSS
- **HTTPS**: 数据加密传输

## 八、监控与运维

### 8.1 日志

- **日志收集**: 统一收集到ELK或Loki
- **日志级别**: 区分DEBUG、INFO、WARN、ERROR
- **链路追踪**: SkyWalking/Zipkin

### 8.2 监控

- **应用监控**: Spring Boot Actuator
- **指标监控**: Prometheus + Grafana
- **告警**: 钉钉/邮件通知

### 8.3 容器化

- **Docker**: 容器化部署
- **Docker Compose**: 本地开发环境
- **K8s** (生产): 容器编排（可选）

## 九、部署架构

### 9.1 开发环境

```
Docker Compose启动：
- MySQL
- Redis
- Nacos
- RabbitMQ
- MinIO
- Elasticsearch
```

### 9.2 生产环境（建议）

```
Nginx (负载均衡)
    │
    ├── Gateway-1, Gateway-2 (高可用)
    │
    ├── User-Service集群
    ├── Content-Service集群
    ├── Comment-Service集群
    └── ...其他服务集群
```

## 十、API设计规范

### 10.1 RESTful API

- GET: 查询
- POST: 创建
- PUT: 全量更新
- PATCH: 部分更新
- DELETE: 删除

### 10.2 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

### 10.3 错误码设计

- 2xx: 成功
- 4xx: 客户端错误（400-参数错误，401-未认证，403-无权限，404-资源不存在）
- 5xx: 服务端错误（500-服务器错误，503-服务不可用）

## 十一、开发规范

### 11.1 代码规范

- 遵循阿里巴巴Java开发手册
- 使用CheckStyle、SpotBugs等工具检查
- 统一代码格式化配置

### 11.2 Git规范

- **分支策略**: master/main、develop、feature/*、hotfix/*
- **提交信息**: 使用约定式提交（Conventional Commits）

### 11.3 接口文档

- 使用Knife4j/Swagger自动生成API文档
- 及时更新接口变更

## 十二、性能优化

### 12.1 数据库优化

- 索引优化
- 慢查询监控
- 连接池配置
- 读写分离

### 12.2 应用优化

- 异步处理
- 缓存预热
- 连接复用
- 批量操作

### 12.3 前端优化

- 代码分割
- 懒加载
- 图片压缩
- CDN加速

## 十三、各服务命名与推荐包结构

下表展示平台每个核心微服务的推荐命名及主包结构（以 Java + Spring Boot 标准风格为例）：

| 服务       | 推荐服务名                | 主包                  | 示例端口 |
|------------|---------------------------|-----------------------|----------|
| API网关    | contenthub-gateway        | com.contenthub.gateway|   8080   |
| 用户服务   | contenthub-user-service   | com.contenthub.user   |   8001   |
| 内容服务   | contenthub-content-service| com.contenthub.content|   8002   |
| 评论服务   | contenthub-comment-service| com.contenthub.comment|   8003   |
| 通知服务   | contenthub-notification-service | com.contenthub.notification | 8004 |
| 搜索服务   | contenthub-search-service | com.contenthub.search |   8005   |
| 文件服务   | contenthub-file-service   | com.contenthub.file   |   8006   |
| 管理服务   | contenthub-admin-service  | com.contenthub.admin  |   8007   |

**推荐Spring Boot微服务规范包结构（以用户服务为例）：**

```
com.contenthub.user
 ├── api           // Feign接口、DTO
 ├── config        // 配置类
 ├── controller    // 控制器（Rest API）
 ├── domain        // 领域模型（DO/Entity）
 ├── dto           // 数据传输对象
 ├── mapper        // MyBatis/DAO接口
 ├── service       // 业务逻辑接口
 ├── service.impl  // 业务逻辑实现类
 ├── vo            // 前端展示对象
 ├── utils         // 工具类
 └── Application.java // 启动入口类
```

**各服务包结构举例**（content为内容服务/notification为通知服务... 其余同理）：

- com.contenthub.content
- com.contenthub.notification
- com.contenthub.comment

**说明：**
- 每个微服务为一个独立Spring Boot项目，包名建议 com.contenthub.[service]，如 com.contenthub.user。
- 每个服务内划分为 controller / service / domain / mapper / config 等标准子包，建议与DDD风格或Spring Cloud实践接轨。
- 接口层（api）可做远程调用DTO、Feign等抽象。

如有详细分层、领域驱动设计或聚合根设计需求也可单独说明。

