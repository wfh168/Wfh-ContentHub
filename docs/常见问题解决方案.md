# 常见问题解决方案

## 一、启动失败问题

### 1. 循环依赖错误

**错误信息**：
```
The dependencies of some of the beans in the application context form a cycle
documentationPluginsBootstrapper -> webMvcRequestHandlerProvider -> SentinelWebAutoConfiguration
```

**原因**：
Knife4j（Swagger 3.0）与Sentinel的自动配置产生了循环依赖冲突。

**解决方案**：

#### 方案一：允许循环依赖（推荐，简单快速）

在 `application.yml` 中添加：
```yaml
spring:
  main:
    allow-circular-references: true
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
```

**说明**：
- `allow-circular-references: true` 解决循环依赖问题
- `matching-strategy: ant_path_matcher` 解决Spring Boot 2.6+与Swagger的兼容性问题

#### 方案二：调整Knife4j配置

修改 `Knife4jConfig.java`：
```java
@Configuration
@EnableSwagger2
@ConditionalOnProperty(name = "knife4j.enable", havingValue = "true", matchIfMissing = true)
public class Knife4jConfig {
    // 配置内容
}
```

#### 方案三：降级Knife4j版本

在父 `pom.xml` 中修改：
```xml
<knife4j.version>2.0.9</knife4j.version>
```

并使用对应的依赖：
```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-spring-boot-starter</artifactId>
    <version>2.0.9</version>
</dependency>
```

#### 方案四：使用SpringDoc替代Swagger

移除Knife4j依赖，添加SpringDoc：
```xml
<dependency>
    <groupId>org.springdoc</groupId>
    <artifactId>springdoc-openapi-ui</artifactId>
    <version>1.7.0</version>
</dependency>
```

---

### 2. Swagger/Knife4j NPE错误

**错误信息**：
```
java.lang.NullPointerException: Cannot invoke "org.springframework.web.servlet.mvc.condition.PatternsRequestCondition.getPatterns()" because "this.condition" is null
```

**原因**：
Spring Boot 2.6+版本改变了路径匹配策略（从`ant_path_matcher`改为`path_pattern_parser`），Swagger 3.0.0还不支持新策略。

**解决方案**：

在 `application.yml` 中配置使用旧的路径匹配策略：
```yaml
spring:
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
```

**其他方案**：
1. 升级到Knife4j 4.x版本（需要改动较大）
2. 降级Spring Boot到2.5.x版本（不推荐）

---

### 3. Nacos连接失败

**错误信息**：
```
ConnectException: Connection refused: connect
```

**解决方案**：
1. 确认Nacos服务已启动
2. 检查Nacos地址和端口是否正确
3. 检查防火墙设置

```bash
# 启动Nacos（Windows）
cd nacos/bin
startup.cmd -m standalone

# 访问Nacos控制台
http://192.168.200.130:8848/nacos
用户名: nacos
密码: nacos
```

---

### 4. MySQL连接失败

**错误信息**：
```
Communications link failure
```

**解决方案**：
1. 确认MySQL服务已启动
2. 检查数据库连接信息
3. 确认数据库已创建

```bash
# 检查MySQL服务
mysql -h 192.168.200.130 -u root -p123456

# 创建数据库
CREATE DATABASE IF NOT EXISTS content_hub;

# 执行初始化脚本
mysql -h 192.168.200.130 -u root -p123456 < database/init.sql
```

---

### 4. Redis连接失败

**错误信息**：
```
Unable to connect to Redis
```

**解决方案**：
1. 确认Redis服务已启动
2. 检查Redis密码配置

```bash
# 测试Redis连接
redis-cli -h 192.168.200.130 -p 6379 -a 654321
```

---

## 二、编译问题

### 1. 找不到符号错误

**错误信息**：
```
cannot find symbol
```

**解决方案**：
```bash
# 清理并重新编译
mvn clean install -DskipTests

# 如果还有问题，删除本地仓库缓存
rm -rf ~/.m2/repository/com/contenthub
mvn clean install -DskipTests
```

---

### 2. 依赖冲突

**错误信息**：
```
MethodNotFoundException 或 ClassNotFoundException
```

**解决方案**：
1. 检查依赖版本是否匹配
2. 使用Maven Helper插件查看依赖树
3. 排除冲突的依赖

```xml
<dependency>
    <groupId>某个依赖</groupId>
    <artifactId>某个包</artifactId>
    <exclusions>
        <exclusion>
            <groupId>冲突的包</groupId>
            <artifactId>冲突的包</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

---

## 三、运行时问题

### 1. Token验证失败

**错误信息**：
```json
{"code": 401, "message": "未登录或Token已过期"}
```

**解决方案**：
1. 检查Token是否正确携带
2. 确认Token格式：`Authorization: Bearer {token}`
3. 检查Token是否过期（默认7天）
4. 重新登录获取新Token

---

### 2. 接口404错误

**原因**：
- 服务未启动
- 路由配置错误
- 服务未注册到Nacos

**解决方案**：
1. 检查服务是否启动成功
2. 访问Nacos控制台查看服务注册情况
3. 检查网关路由配置

```yaml
# 检查网关配置
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://contenthub-user-service
          predicates:
            - Path=/api/user/**
```

---

### 3. 参数校验失败

**错误信息**：
```json
{"code": 400, "message": "用户名长度必须在3-20之间"}
```

**解决方案**：
检查请求参数是否符合DTO中的校验规则：
- `@NotBlank`: 不能为空
- `@Size`: 长度限制
- `@Email`: 邮箱格式
- `@Pattern`: 正则表达式

---

## 四、性能问题

### 1. 启动速度慢

**解决方案**：
1. 增加JVM内存
```bash
# 在启动参数中添加
-Xms512m -Xmx1024m
```

2. 禁用不必要的自动配置
```yaml
spring:
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
```

---

### 2. 接口响应慢

**解决方案**：
1. 添加索引优化数据库查询
2. 使用Redis缓存热点数据
3. 开启数据库连接池
4. 检查慢SQL日志

```yaml
# 开启SQL日志
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

---

## 五、开发调试技巧

### 1. 查看日志

```bash
# 查看实时日志
tail -f logs/contenthub-user-service.log

# 查看错误日志
tail -f logs/contenthub-user-service-error.log
```

### 2. 使用Postman测试

1. 创建环境变量
```
base_url: http://localhost:8080
token: {{登录后获取的token}}
```

2. 全局设置Authorization
```
Key: Authorization
Value: Bearer {{token}}
```

### 3. 使用Knife4j调试

访问：`http://localhost:8001/doc.html`

1. 先调用登录接口获取Token
2. 点击右上角"授权"按钮
3. 输入Token（不需要Bearer前缀）
4. 测试其他接口

---

## 六、Docker部署问题

### 1. 容器无法访问宿主机服务

**解决方案**：
使用host.docker.internal代替localhost
```yaml
spring:
  datasource:
    url: jdbc:mysql://host.docker.internal:3306/content_hub
```

---

### 2. 容器间网络通信问题

**解决方案**：
创建Docker网络
```bash
docker network create contenthub-network
docker run --network contenthub-network ...
```

---

## 七、获取帮助

1. **查看日志文件**
   - `./logs/{服务名}.log`
   - `./logs/{服务名}-error.log`

2. **检查配置文件**
   - `application.yml`
   - Nacos配置中心

3. **使用监控工具**
   - Actuator健康检查：`http://localhost:8001/actuator/health`
   - Nacos控制台：`http://192.168.200.130:8848/nacos`

4. **联系技术支持**
   - 提供完整的错误日志
   - 说明操作步骤
   - 提供环境信息（JDK版本、Maven版本等）

