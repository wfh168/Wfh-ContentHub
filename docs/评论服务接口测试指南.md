# 评论服务接口测试指南

## ⚠️ 重要提示

**在测试评论功能之前，请先执行测试文章数据脚本！**

由于评论表有外键约束（`article_id` 必须存在于 `articles` 表中），需要先创建测试文章。

### 执行测试文章脚本

```bash
# 方式1: 使用MySQL客户端
mysql -h 192.168.200.130 -u root -p123456 content_hub < database/test_data_articles.sql

# 方式2: 使用MySQL命令行
mysql -h 192.168.200.130 -u root -p123456
USE content_hub;
SOURCE database/test_data_articles.sql;
```

**或者直接在数据库中执行以下SQL：**

```sql
USE content_hub;

INSERT INTO `articles` (
    `id`, `user_id`, `category_id`, `title`, `slug`, `summary`, `content`, 
    `status`, `published_at`, `created_at`, `updated_at`, `deleted`
) VALUES
(
    1, 1, 1,
    '测试文章1：Spring Boot微服务架构实践',
    'spring-boot-microservices-practice',
    '本文介绍如何使用Spring Boot构建微服务架构。',
    '# Spring Boot微服务架构实践\n\n这篇文章用于测试评论功能。',
    1, NOW(), NOW(), NOW(), 0
),
(
    2, 1, 2,
    '测试文章2：生活中的小确幸',
    'little-happiness-in-life',
    '记录生活中那些让人感到温暖和快乐的小事。',
    '# 生活中的小确幸\n\n这篇文章用于测试评论功能。',
    1, NOW(), NOW(), NOW(), 0
),
(
    3, 1, 3,
    '测试文章3：职场新人指南',
    'newcomer-guide-to-workplace',
    '分享一些职场新人的经验。',
    '# 职场新人指南\n\n这篇文章用于测试评论功能。',
    1, NOW(), NOW(), NOW(), 0
)
ON DUPLICATE KEY UPDATE
    `title` = VALUES(`title`),
    `content` = VALUES(`content`),
    `summary` = VALUES(`summary`),
    `updated_at` = NOW();
```

---

## 前提准备

### 1. 服务地址
- **用户服务**: http://localhost:8001
- **评论服务**: http://localhost:8003

### 3. 测试文章ID
执行上述SQL后，可以使用以下文章ID进行测试：
- **文章ID 1**: 测试文章1（技术类）
- **文章ID 2**: 测试文章2（生活类）
- **文章ID 3**: 测试文章3（职场类）

### 4. 获取用户Token（用户ID: 1, 2, 3）

#### 步骤1: 获取验证码

```bash
# 获取验证码图片
curl -X GET "http://localhost:8001/user/captcha" \
  -H "accept: */*"
```

**响应示例：**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "captchaKey": "captcha:abc123def456",
    "captchaImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
  }
}
```

#### 步骤2: 用户登录（使用验证码）

**用户ID=1 (admin):**
```bash
curl -X POST "http://localhost:8001/user/login" \
  -H "accept: */*" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "captchaKey": "captcha:abc123def456",
    "captchaCode": "ABCD"
  }'
```

**用户ID=2:**
```bash
curl -X POST "http://localhost:8001/user/login" \
  -H "accept: */*" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user2",
    "password": "password2",
    "captchaKey": "captcha:abc123def456",
    "captchaCode": "ABCD"
  }'
```

**用户ID=3:**
```bash
curl -X POST "http://localhost:8001/user/login" \
  -H "accept: */*" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "user3",
    "password": "password3",
    "captchaKey": "captcha:abc123def456",
    "captchaCode": "ABCD"
  }'
```

**登录响应示例：**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "nickname": "管理员",
    "avatarUrl": null,
    "token": "b518f232-14e0-4a67-b4c8-b2e4d76605dd"
  }
}
```

**保存Token：**
- 用户1的Token: `TOKEN_USER1=b518f232-14e0-4a67-b4c8-b2e4d76605dd`
- 用户2的Token: `TOKEN_USER2=xxx-xxx-xxx`
- 用户3的Token: `TOKEN_USER3=yyy-yyy-yyy`

---

## 评论接口测试

### 1. 发表一级评论（用户1评论文章1）

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: b518f232-14e0-4a67-b4c8-b2e4d76605dd" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "这是一条一级评论，用户1评论文章1"
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "这是一条一级评论，用户1评论文章1"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "评论发表成功",
  "data": 1
}
```

---

### 2. 发表一级评论（用户2评论文章1）

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER2}" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "用户2也来评论一下，这篇文章很不错！"
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "用户2也来评论一下，这篇文章很不错！"
}
```

---

### 3. 发表一级评论（用户3评论文章1）

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER3}" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "用户3的观点：非常赞同！"
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "用户3的观点：非常赞同！"
}
```

---

### 4. 发表二级评论（用户2回复用户1的评论）

假设用户1的评论ID是1：

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER2}" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "用户2回复用户1：说得对！",
    "parentId": 1,
    "rootId": 1
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "用户2回复用户1：说得对！",
  "parentId": 1,
  "rootId": 1
}
```

**注意：**
- `parentId`: 被回复的评论ID（父评论ID）
- `rootId`: 一级评论ID（如果回复的是二级评论，则指向该二级评论的一级评论）
- 如果回复的是一级评论，`rootId` 应该等于 `parentId`

---

### 5. 发表二级评论（用户3回复用户1的评论）

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER3}" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "用户3回复用户1：我也这么认为！",
    "parentId": 1,
    "rootId": 1
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "用户3回复用户1：我也这么认为！",
  "parentId": 1,
  "rootId": 1
}
```

---

### 6. 发表二级评论（用户3回复用户2的二级评论）

假设用户2的评论ID是4（二级评论），用户1的评论ID是1（一级评论）：

```bash
curl -X POST "http://localhost:8003/comment/create" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER3}" \
  -H "Content-Type: application/json" \
  -d '{
    "articleId": 1,
    "content": "用户3回复用户2：同意你的观点！",
    "parentId": 4,
    "rootId": 1
  }'
```

**JSON请求体：**
```json
{
  "articleId": 1,
  "content": "用户3回复用户2：同意你的观点！",
  "parentId": 4,
  "rootId": 1
}
```

---

### 7. 获取评论列表（公开接口，不需要登录）

```bash
curl -X GET "http://localhost:8003/comment/list?articleId=1&page=1&size=20" \
  -H "accept: */*"
```

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 3,
      "articleId": 1,
      "userId": 3,
      "username": "user3",
      "nickname": "用户3",
      "avatarUrl": null,
      "parentId": null,
      "rootId": null,
      "content": "用户3的观点：非常赞同！",
      "likeCount": 0,
      "isLiked": false,
      "createdAt": "2024-10-31T12:00:00",
      "updatedAt": "2024-10-31T12:00:00",
      "children": []
    },
    {
      "id": 2,
      "articleId": 1,
      "userId": 2,
      "username": "user2",
      "nickname": "用户2",
      "avatarUrl": null,
      "parentId": null,
      "rootId": null,
      "content": "用户2也来评论一下，这篇文章很不错！",
      "likeCount": 1,
      "isLiked": false,
      "createdAt": "2024-10-31T11:00:00",
      "updatedAt": "2024-10-31T11:00:00",
      "children": []
    },
    {
      "id": 1,
      "articleId": 1,
      "userId": 1,
      "username": "admin",
      "nickname": "管理员",
      "avatarUrl": null,
      "parentId": null,
      "rootId": null,
      "content": "这是一条一级评论，用户1评论文章1",
      "likeCount": 2,
      "isLiked": true,
      "createdAt": "2024-10-31T10:00:00",
      "updatedAt": "2024-10-31T10:00:00",
      "children": [
        {
          "id": 4,
          "articleId": 1,
          "userId": 2,
          "username": "user2",
          "nickname": "用户2",
          "avatarUrl": null,
          "parentId": 1,
          "rootId": 1,
          "content": "用户2回复用户1：说得对！",
          "likeCount": 0,
          "isLiked": false,
          "createdAt": "2024-10-31T10:30:00",
          "updatedAt": "2024-10-31T10:30:00",
          "children": []
        },
        {
          "id": 5,
          "articleId": 1,
          "userId": 3,
          "username": "user3",
          "nickname": "用户3",
          "avatarUrl": null,
          "parentId": 1,
          "rootId": 1,
          "content": "用户3回复用户1：我也这么认为！",
          "likeCount": 0,
          "isLiked": false,
          "createdAt": "2024-10-31T10:45:00",
          "updatedAt": "2024-10-31T10:45:00",
          "children": []
        }
      ]
    }
  ]
}
```

---

### 8. 获取评论详情（公开接口）

```bash
curl -X GET "http://localhost:8003/comment/1" \
  -H "accept: */*"
```

---

### 9. 点赞评论（用户2给评论1点赞）

```bash
curl -X POST "http://localhost:8003/comment/1/like" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER2}"
```

---

### 10. 点赞评论（用户3给评论1点赞）

```bash
curl -X POST "http://localhost:8003/comment/1/like" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER3}"
```

---

### 11. 点赞评论（用户1给评论2点赞）

```bash
curl -X POST "http://localhost:8003/comment/2/like" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER1}"
```

---

### 12. 检查是否已点赞

```bash
curl -X GET "http://localhost:8003/comment/1/like/check" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER2}"
```

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

---

### 13. 取消点赞

```bash
curl -X DELETE "http://localhost:8003/comment/1/like" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER2}"
```

---

### 14. 删除评论（只能删除自己的评论）

```bash
curl -X DELETE "http://localhost:8003/comment/1" \
  -H "accept: */*" \
  -H "Authorization: ${TOKEN_USER1}"
```

---

### 15. 获取评论数量

```bash
curl -X GET "http://localhost:8003/comment/count?articleId=1" \
  -H "accept: */*"
```

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": 5
}
```

---

## 完整测试场景示例

### 场景：三个用户交互评论文章1

```bash
# 1. 用户1登录并获取Token
TOKEN_USER1=$(curl -s -X POST "http://localhost:8001/user/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123","captchaKey":"xxx","captchaCode":"ABCD"}' \
  | jq -r '.data.token')

# 2. 用户1发表一级评论
curl -X POST "http://localhost:8003/comment/create" \
  -H "Authorization: $TOKEN_USER1" \
  -H "Content-Type: application/json" \
  -d '{"articleId":1,"content":"用户1的第一条评论"}'

# 3. 用户2登录并获取Token
TOKEN_USER2=$(curl -s -X POST "http://localhost:8001/user/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"user2","password":"password2","captchaKey":"xxx","captchaCode":"ABCD"}' \
  | jq -r '.data.token')

# 4. 用户2发表一级评论
curl -X POST "http://localhost:8003/comment/create" \
  -H "Authorization: $TOKEN_USER2" \
  -H "Content-Type: application/json" \
  -d '{"articleId":1,"content":"用户2的观点"}'

# 5. 用户2回复用户1的评论（假设用户1的评论ID是1）
curl -X POST "http://localhost:8003/comment/create" \
  -H "Authorization: $TOKEN_USER2" \
  -H "Content-Type: application/json" \
  -d '{"articleId":1,"content":"用户2回复用户1","parentId":1,"rootId":1}'

# 6. 用户2给用户1的评论点赞
curl -X POST "http://localhost:8003/comment/1/like" \
  -H "Authorization: $TOKEN_USER2"

# 7. 用户3登录并获取Token
TOKEN_USER3=$(curl -s -X POST "http://localhost:8001/user/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"user3","password":"password3","captchaKey":"xxx","captchaCode":"ABCD"}' \
  | jq -r '.data.token')

# 8. 用户3回复用户1的评论
curl -X POST "http://localhost:8003/comment/create" \
  -H "Authorization: $TOKEN_USER3" \
  -H "Content-Type: application/json" \
  -d '{"articleId":1,"content":"用户3回复用户1","parentId":1,"rootId":1}'

# 9. 用户3给评论1点赞
curl -X POST "http://localhost:8003/comment/1/like" \
  -H "Authorization: $TOKEN_USER3"

# 10. 获取评论列表（查看所有评论）
curl -X GET "http://localhost:8003/comment/list?articleId=1&page=1&size=20"
```

---

## 注意事项

1. **Token获取**：每次登录会生成新的Token，Token在Header中传递，格式为 `Authorization: {token}`（不需要Bearer前缀）

2. **验证码**：登录需要先获取验证码，验证码key和code需要匹配

3. **评论结构**：
   - 一级评论：`parentId` 和 `rootId` 都为 `null`
   - 二级评论：`parentId` 指向被回复的评论ID，`rootId` 指向一级评论ID

4. **权限验证**：
   - 发表、删除、点赞评论需要登录
   - 查看评论列表和详情不需要登录（公开接口）

5. **分页参数**：
   - `page`: 页码，从1开始
   - `size`: 每页数量，默认20

